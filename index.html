<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kakebo App v3.8.1 (Login + Sync base)</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>Kakebo ‚Äì Gestione Spese</h1>
      <nav id="tabs" class="hidden">
        <button id="tab-inserimento" class="tab active">Inserimento dati</button>
        <button id="tab-riepilogo" class="tab">Riepilogo mensile</button>
        <button id="tab-riepilogo-sett" class="tab">Riepilogo settimanale</button>
        <button id="tab-riepilogo-tri" class="tab">Riepilogo trimestrale</button>
        <button id="tab-riepilogo-ann" class="tab">Riepilogo annuale</button>
        <button id="tab-dashboard" class="tab">Dashboard</button>
      </nav>
    </div>
    <div class="header-right">
      <button id="theme-toggle" title="Cambia tema">üåô/‚òÄÔ∏è</button>
      <div id="auth-box">
        <span id="auth-email" class="muted"></span>
        <button id="btn-logout" class="secondary hidden">Logout</button>
        <button id="btn-login-open" class="secondary">Login</button>
      </div>
    </div>
  </header>

  <main>
    <!-- LOGIN DIALOG -->
    <section id="sezione-login" class="card hidden">
      <h2>Accedi</h2>
      <p class="hint">Riceverai un <strong>magic link</strong> via email per accedere. Nessuna password da ricordare.</p>
      <form id="form-login" autocomplete="off">
        <label>Email
          <input type="email" id="login-email" placeholder="nome@esempio.it" required />
        </label>
        <div class="actions">
          <button type="submit">Invia magic link</button>
          <button type="button" id="login-close" class="secondary">Annulla</button>
        </div>
      </form>
      <p id="login-msg" class="hint"></p>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <!-- Inserimento -->
      <section id="sezione-inserimento">
        <form id="form-movimento" autocomplete="off">
          <div class="grid">
            <label>Data
              <input type="date" id="data" required/>
            </label>

            <label>Importo (‚Ç¨)
              <input type="number" id="importo" min="0" step="0.01" required/>
            </label>

            <label>Tipo
              <select id="tipo" required>
                <option value="spesa">Spesa</option>
                <option value="entrata">Entrata</option>
                <option value="mutuo">Mutuo (escluso dai totali settimanali)</option>
              </select>
            </label>

            <label>Macro area
              <select id="macro" required></select>
            </label>

            <label>Sotto-categoria
              <select id="categoria" required></select>
            </label>

            <label>Nota (facoltativo)
              <input type="text" id="nota" maxlength="120" placeholder="es. pranzo lavoro, regalo, bolletta‚Ä¶"/>
            </label>
          </div>

          <div class="actions">
            <button type="submit">Aggiungi</button>
            <button type="button" id="pulisci">Pulisci form</button>
            <button type="button" id="cancella-tutto" class="danger">Svuota archivio locale</button>
            <button type="button" id="btn-sync" class="secondary">‚Üª Sincronizza ora</button>
          </div>
        </form>

        <h2>Ultimi movimenti</h2>
        <div class="table-wrap">
          <table id="tabella-movimenti">
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Macro</th>
                <th>Categoria</th>
                <th>Importo</th>
                <th>Nota</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="backup-card">
          <h3>Backup & Ripristino</h3>
          <div class="backup-actions">
            <button id="btn-backup-export" class="secondary">Esporta backup (.kakebo)</button>
            <input type="file" id="input-backup" accept=".kakebo,.json" style="display:none"/>
            <button id="btn-backup-import" class="secondary">Importa backup</button>
            <label class="hint">Il backup contiene solo i tuoi movimenti e resta sul tuo dispositivo finch√© non lo carichi manualmente.</label>
          </div>
        </div>
      </section>

      <!-- Riepilogo mensile -->
      <section id="sezione-riepilogo" class="hidden">
        <div class="filters">
          <label>Mese
            <input type="month" id="mese-riepilogo"/>
          </label>
          <button id="btn-pdf-mensile" class="secondary">Esporta PDF</button>
          <button id="btn-csv-mensile" class="secondary">Esporta CSV</button>
        </div>
        <div id="riepilogo-risultati">
          <h2>Totali per macro area (mese selezionato)</h2>
          <ul id="totali-macro"></ul>
          <h3>Saldo mese (entrate ‚Äì spese)</h3>
          <p id="saldo-mese">‚Äî</p>
          <p class="hint">Nota: il mutuo √® escluso dai totali settimanali, ma √® incluso nel totale spese mensile qui indicato come voce separata.</p>
        </div>
      </section>

      <!-- Riepilogo settimanale -->
      <section id="sezione-riepilogo-sett" class="hidden">
        <div class="filters">
          <label>Mese
            <input type="month" id="mese-riepilogo-sett"/>
          </label>
          <button id="btn-pdf-sett" class="secondary">Esporta PDF</button>
          <button id="btn-csv-sett" class="secondary">Esporta CSV</button>
        </div>
        <div class="table-wrap">
          <table id="tabella-riepilogo-sett">
            <thead>
              <tr>
                <th>Settimana</th>
                <th>Entrate</th>
                <th>Spese (senza mutuo)</th>
                <th>Saldo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="hint">Regola contabile lun‚Äìmer/gio‚Äìdom. Il mutuo √® escluso dai totali settimanali.</p>
      </section>

      <!-- Riepilogo trimestrale -->
      <section id="sezione-riepilogo-tri" class="hidden">
        <div class="filters">
          <label>Anno
            <input type="number" id="anno-tri" min="2000" step="1"/>
          </label>
          <button id="btn-pdf-tri" class="secondary">Esporta PDF</button>
          <button id="btn-csv-tri" class="secondary">Esporta CSV</button>
        </div>
        <div class="table-wrap">
          <table id="tabella-riepilogo-tri">
            <thead>
              <tr>
                <th>Trimestre</th>
                <th>Periodo</th>
                <th>Entrate</th>
                <th>Spese (incl. mutuo)</th>
                <th>Mutuo</th>
                <th>Saldo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Riepilogo annuale -->
      <section id="sezione-riepilogo-ann" class="hidden">
        <div class="filters">
          <label>Anno
            <input type="number" id="anno-ann" min="2000" step="1"/>
          </label>
          <button id="btn-pdf-ann" class="secondary">Esporta PDF</button>
          <button id="btn-csv-ann" class="secondary">Esporta CSV</button>
        </div>
        <div class="table-wrap">
          <table id="tabella-riepilogo-ann">
            <thead>
              <tr>
                <th>Mese</th>
                <th>Entrate</th>
                <th>Spese (incl. mutuo)</th>
                <th>Mutuo</th>
                <th>Saldo mese</th>
                <th>Montante</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th>Totale anno</th>
                <th id="ann-tot-entrate">‚Äî</th>
                <th id="ann-tot-spese">‚Äî</th>
                <th id="ann-tot-mutuo">‚Äî</th>
                <th id="ann-tot-saldo">‚Äî</th>
                <th id="ann-tot-montante">‚Äî</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- Dashboard -->
      <section id="sezione-dashboard" class="hidden">
        <div class="filters">
          <label>Mese
            <input type="month" id="mese-dashboard"/>
          </label>
        </div>
        <h2>Spese per macro (mese selezionato)</h2>
        <div class="chart-wrap">
          <canvas id="chart-macro" width="600" height="300" aria-label="Grafico spese per macro"></canvas>
        </div>
        <p class="hint">Il grafico esclude il mutuo dalle spese; lo mostra come colonna separata.</p>
      </section>
    </section>
  </main>

  <footer>
    <small>v3.8.1 ‚Äî Login + Sync base ‚Äî build 2025-08-31_101218. Dati locali + Sync cloud opzionale.</small>
  </footer>

  <!-- libs first -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- supabase BEFORE app script -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <!-- app -->
  <script src="script.js"></script>
</body>
</html>
