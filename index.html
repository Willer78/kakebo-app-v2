<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kakebo App v3.9.1 (INLINE, hardened)</title>
  <meta name="theme-color" content="#2563eb"/>
  <style>
  :root{--bg:#f7f7fb;--fg:#222;--muted:#6b7280;--card:#fff;--border:#e5e7eb;--accent:#2563eb;--tab:#374151;--tab-active:#2563eb}
  [data-theme='dark']{--bg:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--card:#111827;--border:#1f2937;--accent:#60a5fa;--tab:#1f2937;--tab-active:#3b82f6}
  *{box-sizing:border-box}body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  header{background:#1f2937;color:#fff;padding:16px 20px;position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:20px} nav{margin-top:10px}
  .tab{background:var(--tab);color:#fff;border:none;padding:10px 14px;margin-right:8px;border-radius:8px;cursor:pointer}
  .tab.active{background:var(--tab-active)} main{padding:20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  label{display:flex;flex-direction:column;font-size:14px;gap:6px}
  input,select,button{font-size:14px} input,select{padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--fg)}
  .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);cursor:pointer}
  button:hover{background:#f0f4ff} [data-theme='dark'] button:hover{background:#172554}
  button.danger{border-color:#ef4444;color:#b91c1c}
  h2{margin-top:24px} .table-wrap{overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-top:10px}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left;white-space:nowrap}
  td:last-child{text-align:right}
  .hidden{display:none} .filters{display:flex;gap:14px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  ul{list-style:disc;padding-left:20px} footer{padding:16px 20px;color:var(--muted)} .hint{color:var(--muted);font-size:13px}
  .header-right{display:flex;align-items:center;gap:8px}
  #theme-toggle{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg);cursor:pointer}
  .chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  canvas{max-width:100%}
  .legend{display:flex;gap:12px;flex-wrap:wrap}
  .legend-item{display:flex;align-items:center;gap:6px}
  .color-dot{width:10px;height:10px;border-radius:50%}
  .error-banner{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;margin:12px 0;display:none}
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>Kakebo ‚Äì Gestione Spese (v3.9.1 inline)</h1>
      <nav>
        <button id="tab-inserimento" class="tab active">Inserimento dati</button>
        <button id="tab-riepilogo" class="tab">Riepilogo mensile</button>
        <button id="tab-riepilogo-sett" class="tab">Riepilogo settimanale</button>
        <button id="tab-riepilogo-tri" class="tab">Riepilogo trimestrale</button>
        <button id="tab-riepilogo-ann" class="tab">Riepilogo annuale</button>
        <button id="tab-dashboard" class="tab">Dashboard</button>
      </nav>
    </div>
    <div class="header-right">
      <button id="theme-toggle" title="Tema">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <main>
    <div id="err" class="error-banner"></div>

    <section id="sezione-inserimento">
      <form id="form-movimento" autocomplete="off">
        <div class="grid">
          <label>Data
            <input type="date" id="data" required/>
          </label>
          <label>Importo (‚Ç¨)
            <input type="number" id="importo" min="0" step="0.01" required/>
          </label>
          <label>Tipo
            <select id="tipo">
              <option value="spesa" selected>Spesa</option>
              <option value="entrata">Entrata</option>
              <option value="mutuo">Mutuo (escluso dai totali settimanali)</option>
            </select>
          </label>
          <label id="wrap-macro">Macro area
            <select id="macro">
              <option value="Sopravvivenza" selected>Sopravvivenza</option>
              <option value="Optional">Optional</option>
              <option value="Cultura">Cultura</option>
              <option value="Extra">Extra</option>
            </select>
          </label>
          <label id="wrap-categoria">Sotto-categoria
            <select id="categoria">
              <option value="Alimentazione" selected>Alimentazione</option>
              <option value="Farmacia">Farmacia</option>
              <option value="Cane">Cane</option>
              <option value="Telefono fisso">Telefono fisso</option>
              <option value="Acqua">Acqua</option>
              <option value="Gas">Gas</option>
              <option value="Elettricit√†">Elettricit√†</option>
              <option value="Auto">Auto</option>
              <option value="Moto">Moto</option>
            </select>
          </label>
          <label>Nota
            <input type="text" id="nota" maxlength="120" placeholder="es. pranzo lavoro, regalo, bolletta‚Ä¶"/>
          </label>
        </div>
        <div class="actions">
          <button type="submit">Aggiungi</button>
          <button type="button" id="pulisci">Pulisci form</button>
          <button type="button" id="cancella-tutto" class="danger">Svuota archivio locale</button>
        </div>
      </form>

      <h2>Ultimi movimenti</h2>
      <div class="table-wrap">
        <table id="tabella-movimenti">
          <thead><tr><th>Data</th><th>Tipo</th><th>Macro</th><th>Categoria</th><th>Importo</th><th>Nota</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="sezione-riepilogo" class="hidden">
      <div class="filters">
        <label>Mese <input type="month" id="mese-riepilogo"/></label>
      </div>
      <div id="riepilogo-risultati">
        <h2>Totali per macro (mese selezionato)</h2>
        <ul id="totali-macro"></ul>
        <h3>Saldo mese (entrate ‚Äì spese)</h3>
        <p id="saldo-mese">‚Äî</p>
        <p class="hint">Il mutuo √® escluso dai totali settimanali ma incluso nel totale spese mensile come voce separata.</p>
      </div>
    </section>

    <section id="sezione-riepilogo-sett" class="hidden">
      <div class="filters">
        <label>Mese <input type="month" id="mese-riepilogo-sett"/></label>
      </div>
      <div class="table-wrap">
        <table id="tabella-riepilogo-sett">
          <thead><tr><th>Settimana</th><th>Entrate</th><th>Spese (no mutuo)</th><th>Saldo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="sezione-riepilogo-tri" class="hidden">
      <div class="filters">
        <label>Anno <input type="number" id="anno-tri" min="2000" step="1"/></label>
      </div>
      <div class="table-wrap">
        <table id="tabella-riepilogo-tri">
          <thead><tr><th>Trimestre</th><th>Periodo</th><th>Entrate</th><th>Spese</th><th>Mutuo</th><th>Saldo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="sezione-riepilogo-ann" class="hidden">
      <div class="filters">
        <label>Anno <input type="number" id="anno-ann" min="2000" step="1"/></label>
      </div>
      <div class="table-wrap">
        <table id="tabella-riepilogo-ann">
          <thead><tr><th>Mese</th><th>Entrate</th><th>Spese</th><th>Mutuo</th><th>Saldo</th><th>Montante</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th>Totale anno</th><th id="ann-tot-entrate">‚Äî</th><th id="ann-tot-spese">‚Äî</th><th id="ann-tot-mutuo">‚Äî</th><th id="ann-tot-saldo">‚Äî</th><th id="ann-tot-montante">‚Äî</th></tr></tfoot>
        </table>
      </div>
    </section>

    <section id="sezione-dashboard" class="hidden">
      <div class="filters">
        <label>Mese <input type="month" id="mese-dashboard"/></label>
      </div>
      <h2>Spese per macro (torta, senza mutuo)</h2>
      <div class="chart-wrap">
        <canvas id="chart" width="480" height="300" aria-label="Torta spese per macro (no mutuo)"></canvas>
        <div class="legend" id="legend"></div>
      </div>
    </section>
  </main>

  <footer><small>v3.9.1 inline ‚Äì build 2025-08-31 17:58:55</small></footer>

  <script>
  // ===== Tema =====
  (function(){
    try{
      const saved = localStorage.getItem("kakebo_theme") || "light";
      document.documentElement.setAttribute("data-theme", saved);
      document.getElementById("theme-toggle")?.addEventListener("click", ()=>{
        const cur=document.documentElement.getAttribute("data-theme");
        const next=cur==="light"?"dark":"light";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("kakebo_theme", next);
      });
    }catch(e){ console.error("Theme error", e); }
  })();

  // ===== Helpers =====
  const CATEGORIE = {Sopravvivenza:["Alimentazione","Farmacia","Cane","Telefono fisso","Acqua","Gas","Elettricit√†","Auto","Moto"],
    Optional:["Ristorante","Spese di casa","Cosmesi/ capelli","Shopping","Sport","Cellulare"],
    Cultura:["Libri","Musica","Scuola Eva","Scuola Elena"],
    Extra:["Viaggi","Regali","Spese casa grandi"],
    Entrate:["Stipendio","Assegni familiari","Fotovoltaico","Altre entrate"]};
  const $=s=>document.querySelector(s); const pad=n=>String(n).padStart(2,"0");
  const todayStr=()=>{const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
  const parseDate=s=>{const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D)};
  const addDays=(d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x};
  const startOfMondayWeek=d=>{const day=d.getDay(); const offset=(day===0?-6:1-day); return addDays(d,offset)};
  const endOfSundayWeek=d=> addDays(startOfMondayWeek(d),6);
  function contabileMonthBounds(year,month){const first=new Date(year,month-1,1); const last=new Date(year,month,0);
    const prevLast=new Date(year,month-1,0); const prevLastDow=prevLast.getDay();
    const startMonday=(prevLastDow>=1 && prevLastDow<=3) ? startOfMondayWeek(prevLast) : startOfMondayWeek(first);
    const lastDow=last.getDay(); const endSunday=(lastDow===4 || lastDow===5 || lastDow===6 || lastDow===0) ? endOfSundayWeek(last) : addDays(startOfMondayWeek(last), -1);
    return { startMonday, endExclusiveMonday:addDays(endSunday,1) }; }
  const KEY="kakebo_movimenti_v1"; let MOVIMENTI=[]; try{ MOVIMENTI=JSON.parse(localStorage.getItem(KEY)||"[]"); }catch{ MOVIMENTI=[]; }
  const salva=()=>localStorage.setItem(KEY, JSON.stringify(MOVIMENTI));
  const fmt=n=>`‚Ç¨ ${Number(n||0).toFixed(2)}`;
  const showErr=msg=>{ const el=document.getElementById("err"); if(!el) return; el.textContent=msg; el.style.display="block"; setTimeout(()=>{el.style.display="none"},4000); };

  // ===== Tabs =====
  const tabIns=$("#tab-inserimento"), tabRiep=$("#tab-riepilogo"), tabSett=$("#tab-riepilogo-sett"), tabTri=$("#tab-riepilogo-tri"), tabAnn=$("#tab-riepilogo-ann"), tabDash=$("#tab-dashboard");
  const secIns=$("#sezione-inserimento"), secRiep=$("#sezione-riepilogo"), secSett=$("#sezione-riepilogo-sett"), secTri=$("#sezione-riepilogo-tri"), secAnn=$("#sezione-riepilogo-ann"), secDash=$("#sezione-dashboard");
  function switchTab(which){ [tabIns,tabRiep,tabSett,tabTri,tabAnn,tabDash].forEach(t=>t?.classList.remove("active"));
    [secIns,secRiep,secSett,secTri,secAnn,secDash].forEach(s=>s?.classList.add("hidden"));
    if(which==="ins"){tabIns?.classList.add("active"); secIns?.classList.remove("hidden");}
    else if(which==="riep"){tabRiep?.classList.add("active"); secRiep?.classList.remove("hidden"); aggiornaRiepilogo();}
    else if(which==="sett"){tabSett?.classList.add("active"); secSett?.classList.remove("hidden"); aggiornaRiepilogoSettimanale();}
    else if(which==="tri"){tabTri?.classList.add("active"); secTri?.classList.remove("hidden"); aggiornaRiepilogoTrimestri();}
    else if(which==="ann"){tabAnn?.classList.add("active"); secAnn?.classList.remove("hidden"); aggiornaRiepilogoAnnuale();}
    else {tabDash?.classList.add("active"); secDash?.classList.remove("hidden"); aggiornaDashboard();}}
  tabIns?.addEventListener("click",()=>switchTab("ins"));
  tabRiep?.addEventListener("click",()=>switchTab("riep"));
  tabSett?.addEventListener("click",()=>switchTab("sett"));
  tabTri?.addEventListener("click",()=>switchTab("tri"));
  tabAnn?.addEventListener("click",()=>switchTab("ann"));
  tabDash?.addEventListener("click",()=>switchTab("dash"));

  // ===== Form logic =====
  const inputData=$("#data"), inputImporto=$("#importo"), selTipo=$("#tipo"), selMacro=$("#macro"), selCat=$("#categoria"), inputNota=$("#nota");
  const wrapMacro=$("#wrap-macro"), wrapCategoria=$("#wrap-categoria");

  function setMutuoVisibility(isMutuo){
    if(isMutuo){ wrapMacro?.classList.add("hidden"); wrapCategoria?.classList.add("hidden"); }
    else { wrapMacro?.classList.remove("hidden"); wrapCategoria?.classList.remove("hidden"); }
  }
  function repopulateForTipo(){
    try{
      if(!selTipo||!selMacro||!selCat) return;
      const tipo=selTipo.value;
      if(tipo==="mutuo"){
        setMutuoVisibility(true);
        return;
      }
      setMutuoVisibility(false);
      if(tipo==="entrata"){
        selMacro.innerHTML='<option value="Entrate" selected>Entrate</option>';
        selCat.innerHTML = CATEGORIE.Entrate.map(v=>`<option value="${v}">${v}</option>`).join("");
        selCat.value = CATEGORIE.Entrate[0];
        return;
      }
      const macroOptions=["Sopravvivenza","Optional","Cultura","Extra"];
      const current=macroOptions.includes(selMacro.value) ? selMacro.value : "Sopravvivenza";
      selMacro.innerHTML = macroOptions.map(m=>`<option value="${m}" ${m===current?"selected":""}>${m}</option>`).join("");
      const cats=(CATEGORIE[current]||[]);
      const currentCat = cats.includes(selCat.value) ? selCat.value : (cats[0]||"");
      selCat.innerHTML = cats.map(v=>`<option value="${v}" ${v===currentCat?"selected":""}>${v}</option>`).join("");
    }catch(e){ console.error("repopulateForTipo", e); showErr("Errore nel popolamento dei campi. Riprova."); }
  }
  function onMacroChange(){
    try{
      if(!selMacro||!selCat) return;
      const cats=(CATEGORIE[selMacro.value]||[]);
      selCat.innerHTML = cats.map(v=>`<option value="${v}">${v}</option>`).join("");
      if(cats.length) selCat.value=cats[0];
    }catch(e){ console.error("onMacroChange", e); }
  }

  (function boot(){
    try{
      if(inputData) inputData.value=todayStr();
      repopulateForTipo();
      selTipo?.addEventListener("change", repopulateForTipo);
      selMacro?.addEventListener("change", onMacroChange);
    }catch(e){ console.error("boot error", e); }
  })();

  // ===== Helpers: safe id =====
  function safeId(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch{}
    return "id-"+Date.now()+"-"+Math.random().toString(16).slice(2);
  }

  // ===== Tabella movimenti & storage =====
  function renderTabella(){ try{
    const tbody=document.querySelector("#tabella-movimenti tbody"); if(!tbody) return;
    tbody.innerHTML="";
    (MOVIMENTI||[]).forEach(m=>{ const tr=document.createElement('tr');
      tr.innerHTML=`<td>${m.data}</td><td>${m.tipo}</td><td>${m.macro||""}</td><td>${m.categoria||""}</td><td>‚Ç¨ ${Number(m.importo).toFixed(2)}</td><td>${m.nota||""}</td><td><button class="del" data-id="${m.id}">Elimina</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button.del').forEach(btn=>btn.addEventListener('click',ev=>{ const id=ev.currentTarget.getAttribute('data-id'); MOVIMENTI=(MOVIMENTI||[]).filter(x=>x.id!==id); salva(); renderTabella(); aggiornaTutti(); }));
  }catch(e){ console.error("renderTabella error", e); showErr("Errore nel rendering della tabella."); }}

  document.getElementById('form-movimento')?.addEventListener('submit', e=>{ 
    e.preventDefault();
    try{
      const data=inputData?.value; const importo=parseFloat(inputImporto?.value||""); const tipo=selTipo?.value;
      if(!data || isNaN(importo)){ alert("Controlla data e importo."); return; }
      let macro="", categoria="";
      if(tipo==="mutuo"){ macro="Mutuo"; categoria="‚Äî"; }
      else if(tipo==="entrata"){ macro="Entrate"; categoria=selCat?.value||""; if(!categoria){ alert("Seleziona la voce di entrata."); return; } }
      else { macro=selMacro?.value||""; categoria=selCat?.value||""; if(!macro||!categoria){ alert("Seleziona macro e sotto-categoria."); return; } }
      const nota=(inputNota?.value||"").trim();
      const mov={ id:safeId(), data, importo:Number(importo), tipo, macro, categoria, nota, updated_at:new Date().toISOString() };
      MOVIMENTI=[mov,...(MOVIMENTI||[])]; salva(); renderTabella(); (e.target).reset(); if(inputData) inputData.value=todayStr(); if(selTipo) selTipo.value="spesa"; repopulateForTipo(); aggiornaTutti();
    }catch(err){ console.error("submit error", err); showErr("Errore durante il salvataggio del movimento."); }
  });

  document.getElementById('pulisci')?.addEventListener('click', ()=>{ try{
    document.getElementById('form-movimento')?.reset(); if(inputData) inputData.value=todayStr(); if(selTipo) selTipo.value="spesa"; repopulateForTipo();
  }catch(e){ console.error("pulisci error", e); }});
  document.getElementById('cancella-tutto')?.addEventListener('click', ()=>{ try{
    if(confirm("Svuotare l'archivio locale?")){ MOVIMENTI=[]; salva(); renderTabella(); aggiornaTutti(); }
  }catch(e){ console.error("wipe error", e); showErr("Errore nello svuotare l'archivio."); }});

  // ===== Riepilogo mensile =====
  const inputMese=$("#mese-riepilogo"); (function(){ const d=new Date(); if(inputMese) inputMese.value=`${d.getFullYear()}-${pad(d.getMonth()+1)}`; })();
  function aggiornaRiepilogo(){ try{
    if(!inputMese) return; const prefix=inputMese.value; const delmese=(MOVIMENTI||[]).filter(m=>(m.data||"").startsWith(prefix));
    const totali={}; let entrate=0,spese=0;
    delmese.forEach(m=>{ if(m.tipo==="entrata") entrate+=Number(m.importo); else if(m.tipo==="mutuo"){ spese+=Number(m.importo); totali["Mutuo"]=(totali["Mutuo"]||0)+Number(m.importo); } else { spese+=Number(m.importo); const key=m.macro||"Altro"; totali[key]=(totali[key]||0)+Number(m.importo); } });
    const ul=$("#totali-macro"); if(!ul) return; ul.innerHTML=""; const order=["Sopravvivenza","Optional","Cultura","Extra","Mutuo","Altro"]; let printed=false;
    order.forEach(k=>{ if((totali[k]||0)>0){ const li=document.createElement('li'); li.textContent=`${k}: ‚Ç¨ ${(totali[k]).toFixed(2)}`; ul.appendChild(li); printed=true; } });
    if(!printed){ const li=document.createElement('li'); li.textContent="Nessuna spesa registrata nel mese selezionato."; ul.appendChild(li); }
    const saldo=entrate-spese; document.getElementById("saldo-mese")?.textContent=`Entrate: ‚Ç¨ ${entrate.toFixed(2)} ‚Äì Spese: ‚Ç¨ ${spese.toFixed(2)} ‚Üí Saldo: ‚Ç¨ ${saldo.toFixed(2)}`;
  }catch(e){ console.error("riepilogo error", e); }}
  inputMese?.addEventListener('change', aggiornaRiepilogo);

  // ===== Settimanale =====
  const inputMeseSett=$("#mese-riepilogo-sett"); (function(){ const d=new Date(); if(inputMeseSett) inputMeseSett.value=`${d.getFullYear()}-${pad(d.getMonth()+1)}`; })();
  function formatRange(a,b){ const dd=x=>String(x).padStart(2,"0"); return `${dd(a.getDate())}/${dd(a.getMonth()+1)} ‚Äì ${dd(b.getDate())}/${dd(b.getMonth()+1)}`; }
  function aggiornaRiepilogoSettimanale(){ try{
    if(!inputMeseSett) return; const [Y,M]=inputMeseSett.value.split("-").map(Number); const { startMonday, endExclusiveMonday }=contabileMonthBounds(Y,M);
    const tbody=document.querySelector("#tabella-riepilogo-sett tbody"); if(!tbody) return; tbody.innerHTML="";
    for(let cur=new Date(startMonday); cur<endExclusiveMonday; cur=addDays(cur,7)){ const weekStart=new Date(cur), weekEnd=endOfSundayWeek(weekStart);
      let entrate=0, speseSenzaMutuo=0;
      (MOVIMENTI||[]).forEach(m=>{ if(!m.data) return; const d=parseDate(m.data); if(d>=weekStart && d<=weekEnd){ if(m.tipo==="entrata") entrate+=Number(m.importo); else if(m.tipo==="spesa") speseSenzaMutuo+=Number(m.importo); } });
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${formatRange(weekStart,weekEnd)}</td><td>${fmt(entrate)}</td><td>${fmt(speseSenzaMutuo)}</td><td>${fmt(entrate-speseSenzaMutuo)}</td>`; tbody.appendChild(tr);
    }
  }catch(e){ console.error("settimanale error", e); }}
  inputMeseSett?.addEventListener('change', aggiornaRiepilogoSettimanale);

  // ===== Trimestrale =====
  const inputAnnoTri=$("#anno-tri"); (function(){ const d=new Date(); if(inputAnnoTri) inputAnnoTri.value=d.getFullYear(); })();
  function aggiornaRiepilogoTrimestri(){ try{
    const year=parseInt(inputAnnoTri?.value||"",10); if(isNaN(year)) return;
    const tbody=document.querySelector("#tabella-riepilogo-tri tbody"); if(!tbody) return; tbody.innerHTML="";
    for(let q=1;q<=4;q++){ const startMonth=(q-1)*3; const start=new Date(year,startMonth,1); const end=new Date(year,startMonth+3,0);
      let entrate=0,spese=0,mutuo=0;
      (MOVIMENTI||[]).forEach(m=>{ if(!m.data) return; const d=parseDate(m.data); if(d>=start && d<=end){ if(m.tipo==="entrata") entrate+=Number(m.importo); else if(m.tipo==="mutuo"){ spese+=Number(m.importo); mutuo+=Number(m.importo); } else spese+=Number(m.importo); } });
      const tr=document.createElement('tr'); tr.innerHTML=`<td>Q${q}</td><td>${start.toLocaleDateString()}‚Äì${end.toLocaleDateString()}</td><td>${fmt(entrate)}</td><td>${fmt(spese)}</td><td>${fmt(mutuo)}</td><td>${fmt(entrate-spese)}</td>`; tbody.appendChild(tr);
    }
  }catch(e){ console.error("trimestri error", e); }}
  inputAnnoTri?.addEventListener('change', aggiornaRiepilogoTrimestri);

  // ===== Annuale =====
  const inputAnnoAnn=$("#anno-ann"); (function(){ const d=new Date(); if(inputAnnoAnn) inputAnnoAnn.value=d.getFullYear(); })();
  function monthLabel(i){return ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"][i];}
  function aggiornaRiepilogoAnnuale(){ try{
    const year=parseInt(inputAnnoAnn?.value||"",10); if(isNaN(year)) return;
    const tbody=document.querySelector("#tabella-riepilogo-ann tbody"); if(!tbody) return; tbody.innerHTML="";
    let totE=0,totS=0,totM=0,totSaldo=0,montante=0;
    for(let m=0;m<12;m++){ const start=new Date(year,m,1), end=new Date(year,m+1,0);
      let E=0,S=0,M=0; (MOVIMENTI||[]).forEach(v=>{ if(!v.data) return; const d=parseDate(v.data); if(d>=start && d<=end){ if(v.tipo==="entrata") E+=Number(v.importo); else if(v.tipo==="mutuo"){ S+=Number(v.importo); M+=Number(v.importo); } else S+=Number(v.importo); } });
      const saldo=E-S; montante+=saldo; totE+=E; totS+=S; totM+=M; totSaldo+=saldo;
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${monthLabel(m)}</td><td>${fmt(E)}</td><td>${fmt(S)}</td><td>${fmt(M)}</td><td>${fmt(saldo)}</td><td>${fmt(montante)}</td>`; tbody.appendChild(tr);
    }
    document.getElementById("ann-tot-entrate")?.textContent=fmt(totE);
    document.getElementById("ann-tot-spese")?.textContent=fmt(totS);
    document.getElementById("ann-tot-mutuo")?.textContent=fmt(totM);
    document.getElementById("ann-tot-saldo")?.textContent=fmt(totSaldo);
    document.getElementById("ann-tot-montante")?.textContent=fmt(montante);
  }catch(e){ console.error("annuale error", e); }}
  inputAnnoAnn?.addEventListener('change', aggiornaRiepilogoAnnuale);

  // ===== Dashboard (Pie chart, exclude mutuo) =====
  const inputMeseDash=$("#mese-dashboard"); (function(){ const d=new Date(); if(inputMeseDash) inputMeseDash.value=`${d.getFullYear()}-${pad(d.getMonth()+1)}`; })();
  const COLORS = ["#60a5fa","#34d399","#fbbf24","#f87171"];
  function drawPie(ctx, values, labels){
    const W=ctx.canvas.width, H=ctx.canvas.height; const cx=W/2, cy=H/2, r=Math.min(W,H)*0.35;
    ctx.clearRect(0,0,W,H);
    const total = values.reduce((a,b)=>a+b,0);
    let start= -Math.PI/2;
    values.forEach((v,i)=>{
      const ang = total>0 ? (v/total)*Math.PI*2 : 0;
      ctx.beginPath(); ctx.moveTo(cx,cy);
      ctx.fillStyle=COLORS[i%COLORS.length];
      ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.fill();
      const mid = start + ang/2;
      const lx = cx + Math.cos(mid)*(r+14);
      const ly = cy + Math.sin(mid)*(r+14);
      const perc = total>0 ? Math.round((v/total)*100) : 0;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#222';
      ctx.font="12px system-ui, Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(`${perc}%`, lx, ly);
      start += ang;
    });
    const legend = document.getElementById("legend"); if(legend){ legend.innerHTML="";
      labels.forEach((lab,i)=>{ const item=document.createElement("div"); item.className="legend-item";
        const dot=document.createElement("span"); dot.className="color-dot"; dot.style.background=COLORS[i%COLORS.length];
        const text=document.createElement("span"); text.textContent=`${lab}`; item.appendChild(dot); item.appendChild(text); legend.appendChild(item); });
    }
  }
  function aggiornaDashboard(){
    try{
      const prefix=inputMeseDash?.value||"";
      const mvs=(MOVIMENTI||[]).filter(m=>(m.data||"").startsWith(prefix));
      const labs=["Sopravvivenza","Optional","Cultura","Extra"];
      const values=[0,0,0,0];
      mvs.forEach(m=>{ if(m.tipo==="spesa"){ const idx=labs.indexOf(m.macro||""); if(idx>=0) values[idx]+=Number(m.importo); } });
      const canvas=document.getElementById("chart"); if(!canvas) return;
      const ctx=canvas.getContext("2d"); drawPie(ctx, values, labs);
    }catch(e){ console.error("dashboard error", e); }
  }
  inputMeseDash?.addEventListener('change', aggiornaDashboard);

  // ===== Boot =====
  function aggiornaTutti(){ aggiornaRiepilogo(); aggiornaRiepilogoSettimanale(); aggiornaRiepilogoTrimestri(); aggiornaRiepilogoAnnuale(); aggiornaDashboard(); }
  document.addEventListener("DOMContentLoaded", ()=>{ try{ if(inputData) inputData.value=todayStr(); }catch{} });
  renderTabella(); aggiornaTutti();
  </script>
</body>
</html>
